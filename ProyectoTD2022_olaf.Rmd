# ¿Influye la presencia de bares y restaurantes en los niveles de ruido registrados?
Según un [estudio de concentración de locales en el barrio de Ruzafa](http://www.valencia.es/ayuntamiento/urbanismo2.nsf/0/A577FFDD7E036298C1257D180037E247/$FILE/MODIFICACI%C3%93%20DE%20LES%20NORMES%20URBAN%C3%8DSTIQUES%20DEL%20PLA%20ESPECIAL%20DE%20RUSSAFA-SUD%20GRAN%20VIA%20(PEP-2).pdf?OpenElement?d&embedded=true), realizado por el Ayuntamiento de Valencia en Mayo de 2014, el número total de bares y restaurantes era de 277; 11.37 bares por cada 1000 habitantes del barrio de Ruzafa, es decir, 1.96 veces la media de la ciudad en esas fechas.

Por eso mismo creemos que influirá mucho en los niveles de ruido registrados. Lo comprobaremos haciendo uso de los datos, mediante una visualización geográfica de la ubicación de los sonómetros, bares y restaurantes. Pero, ¿cómo obtener sus respectivas ubicaciones? ¿Qué bares hay en Ruzafa? 

## Datos de bares y restaurantes
Lo que hemos realizado es obtener mediante web scraping la información de estos servicios de hostelería. Los datos han sido extraídos de Google Maps, datos que se pueden obtener haciendo las búsquedas de 'restaurantes ruzafa' y 'bares ruzafa'. No creemos haber conseguido la totalidad de servicios, pero sí los suficientes como para hacer una buena representación.
```{r load hosteleria}
# Carga de datos de bares y restaurantes
bares <- read_delim("./data/bares_ruzafa.csv", delim = "\t", 
                    escape_double = FALSE, trim_ws = TRUE) %>% 
  rename_with(function(x){x <- "name"}, starts_with("Name"))

restaurantes <- read_delim("./data/restaurantes_ruzafa.csv", delim = "\t", 
                           escape_double = FALSE, trim_ws = TRUE) %>% 
  rename_with(function(x){x <- "name"}, starts_with("Name"))
```
Haremos un limpiado básico de los datos para que se adecúen a aquello que buscamos.
```{r clean hosteleria}
# Filtraremos los posibles duplicados
mismos_locales <- base::intersect(bares$name, restaurantes$name) 

hosteleria <- bind_rows(bares, 
                        restaurantes %>% filter(!(name %in% mismos_locales))) %>% 
  select(name, Category, domingo:sábado, Address, Latitude, Longitude) %>% # Variables de posible interés
  filter(between(Longitude, -0.38, -0.368) & between(Latitude, 39.458, 39.465)) %>% 
  filter(!(Category %in% c("Mercado", "Iglesia Católica", "Salón de manicura y pedicura")))
# Filtramos los servicios de hostelería en un rectángulo concreto.
# Eliminamos categorías que no se corresponden con servicios de hostelería.
```
```{r} 
glimpse(hosteleria) # Estructura del dataframe final 
```
Tenemos un total de 226 registros de servicios de hostelería y su correspondiente información.
```{r}
vis_miss(hosteleria)
```
Observamos que solo faltan datos en las variables que corresponden a los horarios. No utilizaremos por ahora esa información, por lo que no es importante que falten esos datos. Podemos proceder a visualizarlos.

## Dataframe de ubicaciones
```{r df_ubi}
lat_ord <- latitude[order(names(ids))]
lon_ord <- longitude[order(names(ids))]

# Dataframe con las ubicaciones y las medianas (según el sensor) de las variables relacionadas con el sonido 
all_df_ubi_median <- complete_data %>% 
  mutate(latitude = rep(lat_ord, nrow(complete_data)/length(ids)),
         longitude = rep(lon_ord, nrow(complete_data)/length(ids))) %>% 
  filter(if_all(everything(), ~!is.na(.x))) %>%
  group_by(street, latitude, longitude) %>% 
  summarise(across(starts_with("LA"), ~median(.x), .names = "median_{.col}")) %>% 
  mutate(nivel = case_when(median_LAeq >= 60.8 ~ "Nivel 3", # Etiquetas para clasificar los más y menos ruidosos
                           median_LAeq < 60.8 & median_LAeq >= 59 ~ "Nivel 2",
                           median_LAeq < 59 ~ "Nivel 1")) %>% 
  arrange(desc(median_LAeq)) %>% 
  ungroup()

# ELIMINAR
library(kableExtra)

all_df_ubi_median[1:8] %>% 
  kbl() %>%
  kable_material(full_width = F) %>% 
  pack_rows("Nivel 3", 1, 6, background = "darkred", color = "white") %>% 
  pack_rows("Nivel 2", 7, 11, background = "red", color = "white") %>% 
  pack_rows("Nivel 1", 12, 14, background = "salmon", color = "white")
```
Utilizaremos este dataframe para la visualización geográfica. Notar que se muestran ya los diferentes niveles establecidos. La diferenciación entre ellos son los valores de la mediana de la variable `LAeq`. El nivel 3 es para valores mayores de 60.8, el nivel 2 si los valores están entre 59 y 60.8 y finalmente, el nivel 1, es para valores menores de 59.

## Visualización geográfica
```{r icons}
# Definimos los iconos que tendrán los sensores y los servicios de hostelería
icon_hosteleria <- makeAwesomeIcon(
  icon = "cutlery",
  iconColor = "black",
  markerColor = "orange"
)

icon_sonometro <- awesomeIconList(
  "Nivel 3" = makeAwesomeIcon(
    icon = "volume-up",
    iconColor = "black",
    markerColor = "darkred",
    library = "fa"
  ),
  "Nivel 2" = makeAwesomeIcon(
    icon = "volume-up",
    iconColor = "black",
    markerColor = "red",
    library = "fa"
  ),
  "Nivel 1" = makeAwesomeIcon(
    icon = "volume-up",
    iconColor = "black",
    markerColor = "lightred",
    library = "fa"
  )
)
```

```{r html-info}
# Caja de información para el mapa interactivo
info.box <- HTML(paste0(
  HTML(
    '<div class="modal fade" id="infobox" role="dialog"><div class="modal-dialog"><!-- Modal content--><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal">&times;</button>'
  ),
  
  # Título
  HTML("<h3>Información</h3>"),
  HTML(
    '</div><div class="modal-body">'
  ),
  
  # Cuerpo del texto
  HTML('<h4>Botones</h4>
<p>En la esquina superior izquierda, hay cinco botones. Los dos primeros son para hacer más y menos zoom; el tercero es para regresar a la vista inicial, el cuarto para buscar y situar la vista en el sensor que queramos y, por último, el botón de mostrar la información.</p>
<hr>
<h4>Interactividad</h4>
<p>En el mapa hay círculos con números en su interior. Este número corresponde a la cantidad de locales que hay en esa zona. Si hacemos click, hará zoom y creará nuevos grupos. Si hacemos click sucesivamente, podremos ver a qué locales corresponden.<br>
Si pinchamos en el local, podremos ver información relativa a ellos. De la misma manera, si hacemos click en un sensor, nos mostrará su información.</p>
<hr>
<h4>Indicaciones breves</h4>
<p>Cuanto más oscuro sea el rojo del círculo que rodea al sensor, más ruidoso es. De la misma forma, cuanto más claro, menos ruidoso. Los locales son aquellos coloreados de naranja. </p>
<hr>
<h4>Obtención de datos</h4>
<p>Datos de los sensores extraídos del <a href="https://www.valencia.es/dadesobertes/es/data/?groups=medio-ambiente">Portal de Datos Abiertos del Ayuntamiento de Valencia</a>.<br>
Datos de bares y restaurantes extraídos de Google Maps a través de web scraping.</p>'),

# Cerrar ventana
HTML('</div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button></div></div>')
))
```

```{r leaflet}
# ELIMINAR
library(leaflet.extras)
library(htmlwidgets)

all_df_ubi_median <- all_df_ubi_median %>% # Variable scaled: median_LAeq entre 0 y 1
  mutate(scaled = (median_LAeq - min(median_LAeq))/(max(median_LAeq)-min(median_LAeq)))

# Ponemos la variable entre 0 y 1 para poder aplicarle una paleta de colores
color_pal <- colorNumeric(palette = colorRamp(c("#FDD49E", "#7F0000"), 
                                              interpolate="spline"),
                          all_df_ubi_median$scaled)

leaflet_hosteleria <- leaflet() %>%
  addProviderTiles("Esri") %>%
  addAwesomeMarkers(data = hosteleria, lng = ~Longitude, lat = ~Latitude, # Marcadores de hostelería
                    clusterOptions = markerClusterOptions(), # Agrupación de marcadores
                    icon = icon_hosteleria,
                    label = ~name,
                    popup = paste0(
                      "<b> Nombre: </b>",
                      hosteleria$name,
                      "<br>",
                      "<b> Categoría: </b>",
                      hosteleria$Category,
                      "<br>",
                      "<b> Dirección: </b>",
                      hosteleria$Address)) %>% 
  setView(lng = median(hosteleria$Longitude), # Vista inicial: mediana de lats y longs para que esté 'centrada'
          lat = median(hosteleria$Latitude), zoom = 16) %>%
  addAwesomeMarkers(data = all_df_ubi_median, lng = ~longitude, lat = ~latitude, # Marcadores sonómetros
                    icon = ~icon_sonometro[nivel],
                    label = ~street,
                    group = "sonometros",
                    popup = paste0(
                      "<b> Nombre: </b>",
                      all_df_ubi_median$street,
                      "<br>",
                      "<b> Mediana LAeq: </b>",
                      all_df_ubi_median$median_LAeq, " dB")) %>% 
  addCircleMarkers(data = all_df_ubi_median, lng = ~longitude, lat = ~latitude,
                   radius = ~3*sqrt(median_LAeq),
                   opacity = 0.8,
                   color = ~color_pal(scaled),
                   fillOpacity = 0.6) %>% 
  addLegend(position = "bottomright", # Añadimos una leyenda orientativa
            labels = c("Nivel 3", "Nivel 2", "Nivel 1"), 
            colors = c("darkred", "red", "salmon"),
            opacity = .7,
            title = "Sonómetros") %>%
  addResetMapButton() %>% # Botón para poder volver a la vista inicial
  addSearchFeatures(targetGroups = "sonometros") %>% # Botón de búsqueda de sonómetro
  addBootstrapDependency() %>%
  addEasyButton(easyButton(
    icon = "glyphicon-info-sign", title = "Información del mapa",
    onClick = JS("function(btn, map){ $('#infobox').modal('show'); }")
  )) %>%
  htmlwidgets::appendContent(info.box)

leaflet_hosteleria
```
# Conclusiones de la visualización geográfica
Gracias a esta visualización podemos observar claramente que los sensores que tienen muchos bares y restaurantes alrededor tienen niveles de ruido mayores. Cuanto más oscuro sea el rojo del círculo que rodea al sensor, más ruidoso es. De la misma forma, cuanto más claro, menos ruidoso.

Notar que es una visualización interactiva. En la esquina superior izquierda, si se hace click en el último botón, se muestra la información relativa a los botones y la interactividad, entre otras cosas. Es recomendable leer esa información y probar a interactuar con el mapa.

Si miramos un poco el mapa, no tardará en aflorar la pregunta: ¿por qué el sensor `cadiz3` es (según nuestro criterio) el más ruidoso, pero no tiene apenas bares o restaurantes alrededor? La respuesta es sencilla. Solo hace falta ver que está situado frente a Gran Via de les Germanies, una vía urbana muy transitada.

Es decir, el ruido que hace la gente en bares y restaurantes es una de las causas de estos altos niveles de ruido, pero también lo es el tráfico de vehículos. Sobre todo en las zonas más próximas a vías urbanas muy transitadas, como es el caso anterior.


```{r date_data}
date_data <- all_df %>% 
  mutate(year = year(dateObserved),
         month = month(dateObserved, label = T, abbr = F),
         weekdayf = factor(wday(dateObserved, label = T, 
                                week_start = 1, abbr = F), ordered = T),
         monthweek = ceiling(day(dateObserved) / 7)) %>% 
  pivot_longer(starts_with("LAeq"), names_to = "medida", values_to = "valor") %>%      
  mutate(text = paste0("Valor: ", valor, " dB\n", "Fecha: ", 
                       day(dateObserved)," de ", 
                       month(dateObserved, label = T, abbr = F), " \n",
                       "Día: ", str_to_title(weekdayf), " \n"))
```

```{r nombres_calle}
# Tabla con equivalencias de nombres abreviados de sensores
calle <- c("Sueca Esq. Denia", "Cádiz, 16", "Cádiz, 3", "Cuba, 3", "Sueca, 2",
           "Sueca, 61", "Sueca, 32", "Carles Cervera, Chaflán Reina Doña María",
           "Salvador Abril Chaflán Maestro José Serrano", "Vivons Chaflán Cádiz", 
           "Carles Cervera, 34", "Puerto Rico, 21", "Doctor Serrano, 21", 
           "General Prim Chaflán Donoso Cortés")
names(calle) <- names(ids)

nombres_calle <- data.frame(nom_abr = names(calle),
                            calle = paste("Calle", calle)) %>%
  arrange(calle)

names(nombres_calle) <- c("Nombre abreviado", "Calle donde se ubica")
```

```{r explicacion_medidas}
# Tabla con la explicación de cada medida
explicacion_medidas <- data.frame(medida = c("LAeq","LAeq_d","LAeq_den","LAeq_e","LAeq_n"),
           explicacion = c("Nivel sonoro continuo equivalente. Se define en la ISO 1996-2:2017 como el valor del nivel de presión en dBA en ponderación A de un sonido estable que en un intervalo de tiempo T posee la misma presión sonora cuadrática media que el sonido que se mide y cuyo nivel varía con el tiempo.",
                           "Es un indicador de ruido asociado al día, donde al día le corresponden 12 horas, en el período que se extiende desde las 7 hasta las 19 horas.",
                           "Índice de ruido día-tarde-noche, es utilizado para determinar la molestia vinculada a la exposición al ruido.",
                           "Es un indicador del nivel sonoro durante la tarde, donde a la tarde le corresponden 4 horas, en el período que se extiende desde las 19 hasta las 23 horas.", 
                           "Es un indicador del nivel sonoro durante la noche, donde a la noche le corresponden 8 horas, en el período que se extiende desde las 23 hasta las 7 horas."))

names(explicacion_medidas) <- c("Medida", "Explicación")
```

```{r escala_ruido}
# Tabla con las escalas de ruido
escala_ruido <- data.frame(valores = c("130", "120", "110", "100", "90", "80", "70", "60", "50", "40", "30", "0"),
                           info = c("Nivel percibido a unos 10 metros de distancia de un avión, el ruido es absolutamente insoportable y doloroso.",
                                    "Muy peligroso; se necesita alguna protección del oído. Este ruido es el emitido por el reactor de un avión volando a 50 metros.",
                                    "Peligrosos y muy molestos. Son habituales en una discoteca, en un concierto de rock y a 100 metros de un avión aterrizando.",
                                    "Riesgo muy grave si la audición es prolongada. Este nivel es frecuente en muchos ambientes laborales industriales.",
                                    "Ambiente muy ruidoso y resultan peligrosos si la exposición se produce por largo tiempo. Es el nivel de ruido característico de un vehículo pesado circulando a 60 km/h y percibido desde unos 10 metros.",
                                    "Ambientes bastante ruidosos, como el de una calle con tránsito intenso o algunos electrodomésticos como aspiradoras o lavadoras.",
                                    "Ambiente ruidoso, habitual en zonas comerciales y muchos bares, en el interior de un tren o de un coche.",
                                    "Ambiente poco ruidoso y es el nivel habitual de sonido de la voz en una conversación normal.",
                                    "Aambiente tranquilo, aunque todavía interfieren en el sueño. Es el nivel habitual de una sala de estudio.",
                                    "Ambiente de calma y admisibles para mantener el sueño.",
                                    "Por debajo de este valor se estima que el ambiente es silencioso.",
                                    "Nivel mínimo de audición"))

names(escala_ruido) <- c("Nivel de presión (dBA)", "Observaciones")
```